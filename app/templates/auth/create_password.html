{% extends "base.html" %}

{% block title %}Create Password - Reconquest Blog{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header text-center" style="background-color: #F1F1F1;">
                    <h4 class="mb-0" style="color: #000000; font-weight: 500;">Create Password</h4>
                </div>
                <div class="card-body">
                    {% include '_messages.html' %}
                    
                    <div id="token-status-message" class="alert alert-info mb-3" style="display:none;">
                        Verifying authentication token...
                    </div>
                    
                    {% if token_expired %}
                    <!-- Display when token is expired -->
                    <div class="text-center mb-4">
                        <i class="fas fa-hourglass-end text-danger" style="font-size: 60px;"></i>
                        <h5 class="mt-3">Token Expired</h5>
                        <p class="text-muted">The password creation link has expired or is invalid.</p>
                        <div class="alert alert-warning">
                            You need to request a new email to create your password.
                        </div>
                        <a href="{{ url_for('auth.forgot_password') }}" class="btn btn-primary">
                            <i class="fas fa-envelope me-2"></i>Request New Email
                        </a>
                    </div>
                    {% elif token_missing %}
                    <!-- Display when token is not found -->
                    <div class="text-center mb-4" id="token-missing-container">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 60px;"></i>
                        <h5 class="mt-3">Token Not Found</h5>
                        <p class="text-muted">The verification token was not found in the URL.</p>
                        <div class="alert alert-warning">
                            Please use the complete link that was sent in your email.
                        </div>
                        <a href="{{ url_for('auth.forgot_password') }}" class="btn btn-primary">
                            <i class="fas fa-envelope me-2"></i>Request New Email
                        </a>
                    </div>
                    {% else %}
                    <!-- Default password creation form -->
                    <div id="password-form-container">
                        <div class="text-center mb-4">
                            <img src="{{ url_for('static', filename='img/mail.png') }}" alt="Email Verification" width="80" class="img-fluid mb-3" onerror="this.style.display='none'">
                            <h5>Create your new password</h5>
                            <p class="text-muted">Almost done! Create a password to secure your account.</p>
                        </div>
                        
                        <form method="POST" id="createPasswordForm">
                            <input type="hidden" name="access_token" id="accessTokenInput">
                            
                            <div class="form-group mb-3">
                                <label for="password" class="form-label">New Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password" name="password" required>
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">Password must be at least 6 characters long.</small>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="confirm_password" class="form-label">Confirm Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">Create Password</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// This code runs as soon as the script is loaded
(function() {
    // Extract token from URL
    function extractTokenFromUrl() {
        let token = null;
        
        // Extract from hash
        const hashPart = window.location.hash.substr(1);
        
        if (hashPart) {
            const hashParams = {};
            hashPart.split('&').forEach(function(part) {
                const pair = part.split('=');
                if (pair[0] && pair[1]) {
                    hashParams[pair[0]] = decodeURIComponent(pair[1]);
                }
            });
            
            // Check for access_token
            if (hashParams.access_token) {
                token = hashParams.access_token;
            }
            // Fallback to token
            else if (hashParams.token) {
                token = hashParams.token;
            }
        }
        
        // If not found in hash, try the query string
        if (!token) {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check for access_token
            let queryToken = urlParams.get('access_token');
            if (queryToken) {
                token = queryToken;
            }
            // Fallback to token
            else {
                queryToken = urlParams.get('token');
                if (queryToken) {
                    token = queryToken;
                }
            }
        }
        
        return token;
    }
    
    // Extract the token immediately
    const token = extractTokenFromUrl();
    
    if (token) {
        // Store the token for use after page load
        window.accessToken = token;
        
        // If there's a hash in the URL, redirect to the same URL without the hash
        // To ensure the token is sent correctly to the server
        if (window.location.hash && !sessionStorage.getItem('redirected')) {
            sessionStorage.setItem('accessToken', token);
            sessionStorage.setItem('redirected', 'true');
            
            // Build the URL without the hash
            let newUrl = window.location.origin + window.location.pathname;
            if (window.location.search) {
                newUrl += window.location.search + '&access_token=' + encodeURIComponent(token);
            } else {
                newUrl += '?access_token=' + encodeURIComponent(token);
            }
            
            window.location.href = newUrl;
        }
    }
})();

document.addEventListener('DOMContentLoaded', function() {
    const tokenStatusMessage = document.getElementById('token-status-message');
    const passwordFormContainer = document.getElementById('password-form-container');
    
    // Check if the token is available
    let token = null;
    
    // Check if we have the token in session (from a previous redirect)
    if (sessionStorage.getItem('accessToken')) {
        token = sessionStorage.getItem('accessToken');
    } 
    // Check if it was extracted previously by the initial script
    else if (window.accessToken) {
        token = window.accessToken;
    } 
    // Try to extract again from the URL
    else {
        // Check the query string first (after redirect)
        const urlParams = new URLSearchParams(window.location.search);
        let queryToken = urlParams.get('access_token');
        if (queryToken) {
            token = queryToken;
        } 
        else {
            // Try to extract from hash again
            const hashPart = window.location.hash.substr(1);
            if (hashPart) {
                const hashParams = {};
                hashPart.split('&').forEach(function(part) {
                    const pair = part.split('=');
                    if (pair[0] && pair[1]) {
                        hashParams[pair[0]] = decodeURIComponent(pair[1]);
                    }
                });
                
                if (hashParams.access_token) {
                    token = hashParams.access_token;
                }
            }
        }
    }

    // Set the token in the form and adjust the visibility of elements
    if (token) {
        document.getElementById('accessTokenInput').value = token;
        
        // Hide token missing message if it exists
        const tokenMissingContainer = document.getElementById('token-missing-container');
        if (tokenMissingContainer) {
            tokenMissingContainer.style.display = 'none';
        }
        
        // Show the password form
        if (passwordFormContainer) {
            passwordFormContainer.style.display = 'block';
        }
        
        // Update status message
        if (tokenStatusMessage) {
            tokenStatusMessage.textContent = "Authentication token valid! You can create your password.";
            tokenStatusMessage.classList.remove('alert-info');
            tokenStatusMessage.classList.add('alert-success');
            tokenStatusMessage.style.display = 'block';
        }
        
        // Send the form with the token to the current page automatically
        // This ensures the server receives the token
        const autoSubmitForm = document.createElement('form');
        autoSubmitForm.method = 'GET';
        autoSubmitForm.action = window.location.pathname;
        autoSubmitForm.style.display = 'none';
        
        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = 'access_token';
        tokenInput.value = token;
        
        autoSubmitForm.appendChild(tokenInput);
        document.body.appendChild(autoSubmitForm);
        
        // Check if there's no token in current URL
        if (!window.location.search.includes('access_token=')) {
            autoSubmitForm.submit();
        }
    } else {
        // Show error message if token is not available
        if (tokenStatusMessage) {
            tokenStatusMessage.textContent = "Authentication token not found or invalid!";
            tokenStatusMessage.classList.remove('alert-info');
            tokenStatusMessage.classList.add('alert-danger');
            tokenStatusMessage.style.display = 'block';
        }
        
        // Hide the password form
        if (passwordFormContainer && !document.getElementById('token-missing-container')) {
            passwordFormContainer.style.display = 'none';
        }
    }
    
    // Setup password visibility toggle
    const togglePassword = document.getElementById('togglePassword');
    const password = document.getElementById('password');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const confirmPassword = document.getElementById('confirm_password');
    
    if (togglePassword && password) {
        togglePassword.addEventListener('click', function() {
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            this.querySelector('i').classList.toggle('fa-eye');
            this.querySelector('i').classList.toggle('fa-eye-slash');
        });
    }
    
    if (toggleConfirmPassword && confirmPassword) {
        toggleConfirmPassword.addEventListener('click', function() {
            const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPassword.setAttribute('type', type);
            this.querySelector('i').classList.toggle('fa-eye');
            this.querySelector('i').classList.toggle('fa-eye-slash');
        });
    }
    
    // Form validation
    const createPasswordForm = document.getElementById('createPasswordForm');
    if (createPasswordForm) {
        createPasswordForm.addEventListener('submit', function(e) {
            const tokenValue = document.getElementById('accessTokenInput').value;
            
            if (!tokenValue) {
                e.preventDefault();
                
                if (confirm('No verification token found. The request may not work properly. Would you like to continue anyway?')) {
                    // Add a temporary token for debug
                    document.getElementById('accessTokenInput').value = 'debug_token_' + new Date().getTime();
                } else {
                    return;
                }
            }
            
            if (password.value !== confirmPassword.value) {
                e.preventDefault();
                alert('Passwords do not match!');
                return;
            }
            
            if (password.value.length < 6) {
                e.preventDefault();
                alert('Password must be at least 6 characters long.');
                return;
            }
        });
    }
});
</script>
{% endblock %} 